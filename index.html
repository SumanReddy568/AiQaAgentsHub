<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Locator Generator</title>
    <!-- Use ai.png for all icons -->
    <link rel="icon" type="image/png" href="ai_png.png">
    <link rel="shortcut icon" type="image/png" href="ai_png.png">
    <link rel="apple-touch-icon" href="ai_png.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body class="gradient-bg">
    <div class="min-h-screen flex flex-col">
        <header class="glass-effect shadow-lg sticky top-0 z-50">
            <div class="max-w-full mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <!-- Replace SVG logo with ai.png image -->
                        <div class="p-3 bg-white rounded-xl shadow-lg flex items-center justify-center"
                            style="width:48px;height:48px;">
                            <img src="ai.png" alt="AI Logo" width="24" height="24"
                                style="display:block;max-width:100%;max-height:100%;">
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Locator Generator Agent</h1>
                            <p class="text-sm text-slate-600">AI-powered test automation assistant</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="api-status"
                            class="hidden flex items-center space-x-2 px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full pulse-animation"></div>
                            <span>AI Ready</span>
                        </div>
                        <button id="settings-btn" class="p-2 rounded-xl hover:bg-white/50 transition-colors">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                </path>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-full mx-auto w-full px-6 py-6">
            <div class="horizontal-layout">
                <!-- Input Section -->
                <div class="input-section">
                    <div class="glass-effect rounded-2xl shadow-xl p-6 section-content">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-xl font-semibold text-slate-800">HTML Input</h2>
                            <div class="flex space-x-2">
                                <button id="clear-btn"
                                    class="px-3 py-1 text-sm bg-slate-200 hover:bg-slate-300 rounded-lg transition-colors">
                                    Clear
                                </button>
                                <button id="format-btn"
                                    class="px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-colors">
                                    Format
                                </button>
                            </div>
                        </div>

                        <textarea id="html-input"
                            class="flex-1 w-full border-2 border-slate-200 rounded-xl p-4 focus:border-blue-400 focus:outline-none transition-colors custom-scrollbar resize-none"
                            style="max-height: 450px; min-height: 200px; height: 300px; overflow-y: auto; margin-bottom: 0;"
                            placeholder="Paste your HTML snippet here...
                            Example:
                            <button id=&quot;submit-btn&quot; class=&quot;btn primary&quot;>Submit</button>
                            <div class=&quot;form-group&quot;>
                            <input type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot;Enter email&quot;>
                            </div>"></textarea>

                        <!-- Remove extra margin between textarea and checkboxes/buttons -->
                        <div
                            class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-2 space-y-3 sm:space-y-0">
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="include-ai" class="rounded" checked>
                                    <label for="include-ai" class="text-sm text-slate-700 flex items-center gap-1">
                                        <img src="image.png" alt="AI"
                                            class="inline-block w-5 h-5 align-middle rounded-full" />
                                        AI Suggestions
                                    </label>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="include-best-practices" class="rounded" checked>
                                    <label for="include-best-practices" class="text-sm text-slate-700">Best
                                        Practices</label>
                                </div>
                            </div>
                            <button id="generate-btn"
                                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none w-full sm:w-auto">
                                <span class="flex items-center justify-center space-x-2">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"></polygon>
                                    </svg>
                                    <span>Generate Locators</span>
                                </span>
                            </button>
                            <div id="chat-bubble"
                                class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:scale-110 transition-transform duration-300">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- Output Section -->
                <div class="output-section">
                    <div class="glass-effect rounded-2xl shadow-xl p-6 section-content">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-slate-800">Generated Locators</h2>
                            <div class="flex space-x-2">
                                <button id="export-btn"
                                    class="px-3 py-1 text-sm bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors disabled:opacity-50"
                                    disabled>
                                    Export
                                </button>
                                <select id="filter-select" class="px-3 py-1 text-sm border border-slate-200 rounded-lg">
                                    <option value="all">All Locators</option>
                                    <option value="ai">AI Generated</option>
                                    <option value="rule">Rule-based</option>
                                    <option value="css">CSS Only</option>
                                    <option value="xpath">XPath Only</option>
                                </select>
                            </div>
                        </div>

                        <div id="output-container" class="flex-1 overflow-y-auto custom-scrollbar -mr-2 pr-2">
                            <div id="crazy-loader" class="hidden flex flex-col items-center justify-center py-12">
                                <!-- Fun crazy loader: spinning emoji and bouncing dots -->
                                <!-- <div class="animate-spin-slow text-5xl mb-4 flex items-center justify-center"
                                    style="animation: spin 1.5s linear infinite;">
                                    <div
                                        style="background: white; border-radius: 9999px; padding: 12px; display: inline-flex; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);">
                                        <img src="ai.png" alt="AI" style="width: 48px; height: 48px; display: block;" />
                                    </div>
                                </div> -->
                                <div class="flex space-x-2">
                                    <div class="w-3 h-3 bg-pink-400 rounded-full animate-bounce"
                                        style="animation-delay:0s"></div>
                                    <div class="w-3 h-3 bg-blue-400 rounded-full animate-bounce"
                                        style="animation-delay:0.2s"></div>
                                    <div class="w-3 h-3 bg-purple-400 rounded-full animate-bounce"
                                        style="animation-delay:0.4s"></div>
                                </div>
                                <div
                                    class="mt-4 text-lg font-bold text-pink-600 dark:text-pink-400 drop-shadow-lg text-center tracking-wide">
                                    AI is conjuring magical locators...
                                </div>
                            </div>
                            <div id="empty-state"
                                class="h-full flex flex-col items-center justify-center text-slate-400">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="1">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10,9 9,9 8,9"></polyline>
                                </svg>
                                <p class="mt-4 text-center font-semibold">Your generated locators will appear here</p>
                                <p class="text-sm text-slate-400">Paste HTML and click "Generate Locators" to get
                                    started</p>
                            </div>
                            <div id="output-content" class="space-y-6 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat Modal -->
        <div id="chat-modal"
            class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 invisible opacity-0 z-50">
            <div
                class="modal-content glass-effect w-full max-w-lg p-6 rounded-2xl shadow-2xl transform scale-95 flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <img src="image.png" alt="AI" class="inline-block w-6 h-6 align-middle rounded-full" />
                        Chat Assistant
                    </h2>
                    <button id="close-chat-modal-btn" class="p-2 rounded-xl hover:bg-slate-200 transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto custom-scrollbar p-2 mb-4 space-y-4">
                    <div class="flex justify-start">
                        <div class="bg-blue-100 text-blue-800 p-3 rounded-xl max-w-[80%] flex items-start gap-2">
                            <img src="image.png" alt="AI"
                                class="inline-block w-5 h-5 align-middle rounded-full mt-0.5" />
                            <div>Hello! I can help you with your locators or answer any questions about the provided
                                HTML.</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <textarea id="chat-input" rows="1"
                        class="flex-1 border-2 border-slate-200 rounded-xl p-3 focus:border-blue-400 focus:outline-none resize-none custom-scrollbar"
                        placeholder="Ask me anything about your HTML..."></textarea>
                    <button id="chat-send-btn"
                        class="p-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition-colors disabled:opacity-50">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" class="-rotate-45">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal"
            class="modal fixed inset-0 bg-black/60 flex items-center justify-center p-4 invisible opacity-0 z-50">
            <div class="modal-content glass-effect w-full max-w-lg p-8 rounded-2xl shadow-2xl transform scale-95">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Settings</h2>
                    <button id="close-modal-btn" class="p-2 rounded-xl hover:bg-slate-200 transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div class="space-y-6">
                    <div>
                        <label for="api-key-input" class="block text-sm font-semibold text-slate-700 mb-3">Gemini API
                            Key</label>
                        <input type="password" id="api-key-input"
                            class="w-full border-2 border-slate-200 rounded-xl p-3 focus:border-blue-400 focus:outline-none transition-colors"
                            placeholder="Enter your Gemini API key">
                        <p class="text-xs text-slate-500 mt-2">Your API key is stored locally and never sent to our
                            servers.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-3">AI Model</label>
                        <select id="model-select"
                            class="w-full border-2 border-slate-200 rounded-xl p-3 focus:border-blue-400 focus:outline-none">
                            <option value="gemini-2.5-pro">Gemini 2.5 Pro (Advanced)</option>
                            <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (Fast & Cost-effective)</option>
                            <option value="gemini-pro">Gemini Pro (Legacy)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-3">Generation Options</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="priority-interactive" class="rounded" checked>
                                <span class="text-sm">Prioritize interactive elements</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="include-explanations" class="rounded" checked>
                                <span class="text-sm">Include detailed explanations</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="stability-focus" class="rounded" checked>
                                <span class="text-sm">Focus on stability over brevity</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-8">
                    <button id="cancel-settings-btn"
                        class="px-4 py-2 text-slate-600 hover:text-slate-800 transition-colors">
                        Cancel
                    </button>
                    <button id="save-settings-btn"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <div id="toast-container" class="fixed bottom-6 left-6 space-y-2 z-50"></div>

        <script>
            // Global state
            let apiKey = '';
            let selectedModel = 'gemini-2.5-flash';
            let generatedLocators = [];
            const showdownConverter = new showdown.Converter();

            // DOM elements
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const modelSelect = document.getElementById('model-select');
            const generateBtn = document.getElementById('generate-btn');
            const htmlInput = document.getElementById('html-input');
            const outputContainer = document.getElementById('output-container');
            const outputContent = document.getElementById('output-content');
            const emptyState = document.getElementById('empty-state');
            const clearBtn = document.getElementById('clear-btn');
            const formatBtn = document.getElementById('format-btn');
            const exportBtn = document.getElementById('export-btn');
            const filterSelect = document.getElementById('filter-select');
            const apiStatus = document.getElementById('api-status');
            const toastContainer = document.getElementById('toast-container');

            // Chat elements
            const chatBubble = document.getElementById('chat-bubble');
            const chatModal = document.getElementById('chat-modal');
            const closeChatModalBtn = document.getElementById('close-chat-modal-btn');
            const chatHistory = document.getElementById('chat-history');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            // Settings modal functions
            function openModal() {
                settingsModal.classList.remove('invisible', 'opacity-0');
                settingsModal.querySelector('.modal-content').classList.remove('scale-95');
            }

            function closeModal() {
                settingsModal.classList.add('invisible', 'opacity-0');
                settingsModal.querySelector('.modal-content').classList.add('scale-95');
            }

            // Event listeners for modal
            settingsBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            cancelSettingsBtn.addEventListener('click', closeModal);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeModal();
            });

            // Save settings
            saveSettingsBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                const model = modelSelect.value;

                if (key) {
                    apiKey = key;
                    selectedModel = model;
                    localStorage.setItem('gemini-api-key', key);
                    localStorage.setItem('selected-model', model);
                    updateApiStatus(true);
                    showToast('Settings saved successfully!', 'success');
                } else {
                    showToast('Please enter a valid API key', 'error');
                    return;
                }

                closeModal();
            });

            // Toast notification system
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500',
                    warning: 'bg-yellow-500'
                };

                toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg transform -translate-x-full transition-transform duration-300 flex items-center space-x-2`;
                toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' ? '<path d="M9 12l2 2 4-4"></path><path d="M21 12c-1 0-3-1-3-3s1.5-3 3-3 3 1 3 3-1.5 3-3 3"></path>' :
                        type === 'error' ? '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>' :
                            '<circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path>'}
                </svg>
                <span>${message}</span>
            `;

                toastContainer.appendChild(toast);

                setTimeout(() => toast.classList.remove('-translate-x-full'), 100);
                setTimeout(() => {
                    toast.classList.add('-translate-x-full');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            // Update API status indicator
            function updateApiStatus(connected) {
                if (connected) {
                    apiStatus.classList.remove('hidden');
                } else {
                    apiStatus.classList.add('hidden');
                }
            }

            // Load saved settings
            function loadSettings() {
                const savedKey = localStorage.getItem('gemini-api-key');
                const savedModel = localStorage.getItem('selected-model');

                if (savedKey) {
                    apiKey = savedKey;
                    apiKeyInput.value = savedKey;
                    updateApiStatus(true);
                }

                if (savedModel) {
                    selectedModel = savedModel;
                    modelSelect.value = savedModel;
                }
            }

            // Clear input
            clearBtn.addEventListener('click', () => {
                htmlInput.value = '';
                clearOutput();
            });

            // Format HTML
            formatBtn.addEventListener('click', () => {
                const html = htmlInput.value.trim();
                if (!html) return;

                try {
                    const formatted = formatHtml(html);
                    htmlInput.value = formatted;
                    showToast('HTML formatted successfully!', 'success');
                } catch (error) {
                    showToast('Error formatting HTML', 'error');
                }
            });

            // Simple HTML formatter
            function formatHtml(html) {
                let formatted = html;
                let indent = 0;
                const tab = '  ';

                formatted = formatted.replace(/></g, '>\n<');

                const lines = formatted.split('\n');
                const result = [];

                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return;

                    if (trimmed.match(/^<\/\w/)) {
                        indent = Math.max(0, indent - 1);
                    }

                    result.push(tab.repeat(indent) + trimmed);

                    if (trimmed.match(/^<\w[^>]*[^/]>$/)) {
                        indent++;
                    }
                });

                return result.join('\n');
            }

            // Export functionality
            exportBtn.addEventListener('click', () => {
                if (generatedLocators.length === 0) return;

                const exportData = {
                    timestamp: new Date().toISOString(),
                    locators: generatedLocators
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `locators-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Locators exported successfully!', 'success');
            });

            // Filter functionality
            filterSelect.addEventListener('change', () => {
                const filterValue = filterSelect.value;
                const sections = outputContent.querySelectorAll('.locator-section');

                sections.forEach(section => {
                    const sectionType = section.dataset.type;
                    let shouldShow = false;

                    switch (filterValue) {
                        case 'all':
                            shouldShow = true;
                            break;
                        case 'ai':
                            shouldShow = sectionType === 'ai';
                            break;
                        case 'rule':
                            shouldShow = sectionType === 'rule';
                            break;
                        case 'css':
                            shouldShow = section.querySelectorAll('.locator-card').length > 0 &&
                                Array.from(section.querySelectorAll('.locator-card')).some(card =>
                                    card.textContent.includes('CSS'));
                            break;
                        case 'xpath':
                            shouldShow = section.querySelectorAll('.locator-card').length > 0 &&
                                Array.from(section.querySelectorAll('.locator-card')).some(card =>
                                    card.textContent.includes('XPath'));
                            break;
                    }

                    section.style.display = shouldShow ? 'block' : 'none';
                });
            });

            // Clear output
            function clearOutput() {
                outputContent.innerHTML = '';
                outputContent.classList.add('hidden');
                emptyState.classList.remove('hidden');
                exportBtn.disabled = true;
                generatedLocators = [];
            }

            // Show output
            function showOutput() {
                emptyState.classList.add('hidden');
                outputContent.classList.remove('hidden');
                exportBtn.disabled = false;
            }

            // Create locator card
            function createLocatorCard(locator, type, explanation = '', priority = 'medium', isAI = false) {
                const priorityColors = {
                    high: 'priority-high bg-green-50',
                    medium: 'priority-medium bg-blue-50',
                    low: 'priority-low bg-yellow-50'
                };

                const card = document.createElement('div');
                card.className = `locator-card p-4 rounded-xl border-2 border-slate-100 ${priorityColors[priority]} fade-in`;

                card.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2 flex-wrap gap-2">
                            ${isAI ? '<div class="ai-badge flex items-center gap-1"><img src="image.png" alt="AI" class="inline-block w-5 h-5 align-middle rounded-full" /> AI Generated</div>' : '<div class="rule-badge">Rule-based</div>'}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${type === 'CSS' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">${type}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${priority === 'high' ? 'bg-green-100 text-green-800' : priority === 'medium' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${priority.toUpperCase()}</span>
                        </div>
                        <button class="copy-btn p-2 rounded-lg hover:bg-white/50 transition-colors flex-shrink-0" title="Copy locator">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="code-block p-3 mb-3 overflow-x-auto">
                        <code class="text-sm text-green-400 font-mono whitespace-pre-wrap break-all">${escapeHtml(locator)}</code>
                    </div>
                    ${explanation ? `<p class="text-sm text-slate-600 leading-relaxed">${explanation}</p>` : ''}
                </div>
            `;

                // Copy functionality
                card.querySelector('.copy-btn').addEventListener('click', () => {
                    copyToClipboard(locator, card.querySelector('.copy-btn'));
                });

                return card;
            }

            // Create section header
            function createSectionHeader(title, count = 0) {
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-6';
                header.innerHTML = `
                <h3 class="text-lg font-semibold text-slate-800">${title}</h3>
                ${count > 0 ? `<span class="px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-sm font-medium">${count} locators</span>` : ''}
            `;
                return header;
            }

            // Copy to clipboard with visual feedback
            function copyToClipboard(text, button) {
                const originalContent = button.innerHTML;

                navigator.clipboard.writeText(text).then(() => {
                    button.classList.add('copy-success');
                    button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4"></path>
                        <path d="M21 12c-1 0-3-1-3-3s1.5-3 3-3 3 1 3 3-1.5 3-3 3"></path>
                    </svg>
                `;

                    setTimeout(() => {
                        button.classList.remove('copy-success');
                        button.innerHTML = originalContent;
                    }, 1500);

                    showToast('Copied to clipboard!', 'success', 1500);
                }).catch(() => {
                    showToast('Failed to copy', 'error');
                });
            }

            // Utility function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Generate rule-based locators
            function generateRuleBasedLocators(htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const elements = doc.body.querySelectorAll('*');

                const locators = [];
                const seenLocators = new Set();

                elements.forEach((element) => {
                    const tagName = element.tagName.toLowerCase();
                    const locatorData = [];

                    // ID-based locators (highest priority)
                    if (element.id) {
                        const cssId = `#${element.id}`;
                        const xpathId = `//${tagName}[@id='${element.id}']`;

                        if (!seenLocators.has(cssId)) {
                            locatorData.push({
                                locator: cssId,
                                type: 'CSS',
                                priority: 'high',
                                explanation: `Unique ID selector - most reliable and fast for targeting this specific element`
                            });
                            seenLocators.add(cssId);
                        }

                        if (!seenLocators.has(xpathId)) {
                            locatorData.push({
                                locator: xpathId,
                                type: 'XPath',
                                priority: 'high',
                                explanation: `ID-based XPath - highly reliable alternative to CSS ID selector`
                            });
                            seenLocators.add(xpathId);
                        }
                    }

                    // Name attribute (for form elements)
                    if (element.name) {
                        const cssName = `${tagName}[name='${element.name}']`;
                        const xpathName = `//${tagName}[@name='${element.name}']`;

                        if (!seenLocators.has(cssName)) {
                            locatorData.push({
                                locator: cssName,
                                type: 'CSS',
                                priority: 'high',
                                explanation: `Name attribute selector - reliable for form elements and stable across UI changes`
                            });
                            seenLocators.add(cssName);
                        }
                    }

                    // Test-specific attributes (data-testid, data-cy, etc.)
                    ['data-testid', 'data-cy', 'data-test'].forEach(attr => {
                        if (element.hasAttribute(attr)) {
                            const value = element.getAttribute(attr);
                            const cssAttr = `[${attr}='${value}']`;
                            const xpathAttr = `//*[@${attr}='${value}']`;

                            if (!seenLocators.has(cssAttr)) {
                                locatorData.push({
                                    locator: cssAttr,
                                    type: 'CSS',
                                    priority: 'high',
                                    explanation: `Test attribute selector - specifically designed for testing, highly stable`
                                });
                                seenLocators.add(cssAttr);
                            }
                        }
                    });

                    // Semantic attributes
                    ['role', 'aria-label', 'placeholder', 'title', 'alt'].forEach(attr => {
                        if (element.hasAttribute(attr)) {
                            const value = element.getAttribute(attr);
                            const cssAttr = `${tagName}[${attr}='${value}']`;

                            if (!seenLocators.has(cssAttr) && value.length < 50) {
                                locatorData.push({
                                    locator: cssAttr,
                                    type: 'CSS',
                                    priority: ['role', 'aria-label'].includes(attr) ? 'high' : 'medium',
                                    explanation: `${attr} attribute selector - semantic meaning provides stability`
                                });
                                seenLocators.add(cssAttr);
                            }
                        }
                    });

                    // Class-based locators (be selective)
                    if (element.classList.length > 0) {
                        const classes = Array.from(element.classList);
                        // Prefer single, meaningful classes
                        const meaningfulClasses = classes.filter(cls =>
                            !cls.match(/^(css-|sc-|_|[a-z0-9]{5,})/) && cls.length > 3
                        );

                        if (meaningfulClasses.length > 0) {
                            const cssClass = '.' + meaningfulClasses[0];
                            if (!seenLocators.has(cssClass)) {
                                locatorData.push({
                                    locator: cssClass,
                                    type: 'CSS',
                                    priority: 'medium',
                                    explanation: `Class-based selector - moderate stability, may change with styling updates`
                                });
                                seenLocators.add(cssClass);
                            }
                        }
                    }

                    // Text-based XPath for buttons and links
                    const text = element.textContent?.trim();
                    if (text && text.length < 30 && ['button', 'a', 'span'].includes(tagName)) {
                        const xpathText = `//${tagName}[normalize-space(text())='${text.replace(/'/g, "\\'")}']`;

                        if (!seenLocators.has(xpathText)) {
                            locatorData.push({
                                locator: xpathText,
                                type: 'XPath',
                                priority: 'medium',
                                explanation: `Text-based locator - good for buttons/links, but fragile if text changes`
                            });
                            seenLocators.add(xpathText);
                        }
                    }

                    locators.push(...locatorData);
                });

                return locators;
            }

            // Robust JSON extraction from AI response
            function extractJsonFromResponse(content) {
                // Try to find JSON block
                let jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[1]);
                    } catch (e) {
                        console.warn('Failed to parse JSON from code block:', e);
                    }
                }

                // Try to find JSON object directly
                const startIndex = content.indexOf('{');
                const endIndex = content.lastIndexOf('}');

                if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                    const jsonString = content.substring(startIndex, endIndex + 1);
                    try {
                        return JSON.parse(jsonString);
                    } catch (e) {
                        console.warn('Failed to parse extracted JSON:', e);
                    }
                }

                // If still no valid JSON, try to construct from response patterns
                const recommendations = [];
                const lines = content.split('\n');

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.includes('cssSelector') || line.includes('css')) {
                        // Try to extract basic info from malformed response
                        const cssMatch = line.match(/[.#][\w-]+|\w+\[[\w-]+.*?\]/);
                        if (cssMatch) {
                            recommendations.push({
                                element: "Detected element",
                                cssSelector: cssMatch[0],
                                xpath: `//*[contains(@class, 'element')]`,
                                priority: "Medium",
                                explanation: "Extracted from AI response"
                            });
                        }
                    }
                }

                if (recommendations.length > 0) {
                    return {
                        recommendations: recommendations,
                        bestPractices: ["Use stable attributes", "Avoid fragile selectors"],
                        antiPatterns: ["Don't rely solely on position", "Avoid overly specific selectors"]
                    };
                }

                throw new Error('No valid JSON or extractable data found in AI response');
            }

            // Generate AI-powered locators
            async function generateAiLocators(htmlContent) {
                if (!apiKey) {
                    throw new Error('API key not configured');
                }

                const includeExplanations = document.getElementById('include-explanations')?.checked ?? true;
                const prioritizeInteractive = document.getElementById('priority-interactive')?.checked ?? true;
                const stabilityFocus = document.getElementById('stability-focus')?.checked ?? true;

                const prompt = `Analyze this HTML and provide test locators. Respond ONLY with valid JSON in this exact format:
                                    {
                                    "recommendations": [
                                        {
                                        "element": "element description",
                                        "cssSelector": "css selector",
                                        "xpath": "xpath expression", 
                                        "priority": "High|Medium|Low",
                                        "explanation": "explanation text"
                                        }
                                    ],
                                    "bestPractices": ["practice1", "practice2"],
                                    "antiPatterns": ["antipattern1", "antipattern2"]
                                    }

                                    HTML to analyze:
                                    \`\`\`html
                                    ${htmlContent}
                                    \`\`\`

                                    Requirements:
                                    - ${prioritizeInteractive ? 'Focus on interactive elements (buttons, inputs, links)' : 'Analyze all elements'}  
                                    - ${stabilityFocus ? 'Prioritize stability over brevity' : 'Balance brevity with stability'}
                                    - Provide both CSS and XPath for each element
                                    - ${includeExplanations ? 'Include detailed explanations' : 'Keep explanations brief'}
                                    - Use High/Medium/Low priority ratings
                                    - Return only the JSON object, no other text`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 4096
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    if (errorMessage.includes('not found') || errorMessage.includes('is not supported')) {
                        errorMessage += '. Please check your API key and model selection.';
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const content = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!content) {
                    throw new Error('Empty response from AI');
                }

                try {
                    return extractJsonFromResponse(content);
                } catch (parseError) {
                    console.error('AI Response:', content);
                    throw new Error(`Failed to parse AI response: ${parseError.message}`);
                }
            }

            // Create AI recommendations section
            function createAiSection(aiData) {
                const section = document.createElement('div');
                section.className = 'locator-section ai-content p-6 rounded-xl fade-in';
                section.dataset.type = 'ai';

                const header = createSectionHeader('ðŸ¤– AI Recommendations', aiData.recommendations?.length || 0);
                section.appendChild(header);

                if (aiData.recommendations && aiData.recommendations.length > 0) {
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 gap-4';

                    aiData.recommendations.forEach(rec => {
                        // CSS Selector card
                        if (rec.cssSelector) {
                            const cssCard = createLocatorCard(
                                rec.cssSelector,
                                'CSS',
                                `${rec.element}: ${rec.explanation}`,
                                rec.priority?.toLowerCase() || 'medium',
                                true
                            );
                            grid.appendChild(cssCard);
                        }

                        // XPath card
                        if (rec.xpath) {
                            const xpathCard = createLocatorCard(
                                rec.xpath,
                                'XPath',
                                `${rec.element}: ${rec.explanation}`,
                                rec.priority?.toLowerCase() || 'medium',
                                true
                            );
                            grid.appendChild(xpathCard);
                        }
                    });

                    section.appendChild(grid);
                }

                // Best practices and anti-patterns
                if (aiData.bestPractices || aiData.antiPatterns) {
                    const adviceContainer = document.createElement('div');
                    adviceContainer.className = 'mt-4 grid grid-cols-1 md:grid-cols-2 gap-3';

                    // Best practices
                    if (aiData.bestPractices && aiData.bestPractices.length > 0) {
                        const practicesDiv = document.createElement('div');
                        practicesDiv.className = 'p-2 bg-green-50 rounded-xl border border-green-200';
                        practicesDiv.innerHTML = `
                            <h4 class="font-semibold text-green-800 mb-2 flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <path d="M21 12c-1 0-3-1-3-3s1.5-3 3-3 3 1 3 3-1.5 3-3 3"></path>
                                </svg>
                                Best Practices
                            </h4>
                            <ul class="text-sm text-green-700 space-y-1">
                                ${aiData.bestPractices.map(practice => `<li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">â€¢</span><span>${escapeHtml(practice)}</span></li>`).join('')}
                            </ul>
                        `;
                        adviceContainer.appendChild(practicesDiv);
                    }

                    // Anti-patterns
                    if (aiData.antiPatterns && aiData.antiPatterns.length > 0) {
                        const antiPatternsDiv = document.createElement('div');
                        antiPatternsDiv.className = 'p-2 bg-red-50 rounded-xl border border-red-200';
                        antiPatternsDiv.innerHTML = `
                            <h4 class="font-semibold text-red-800 mb-2 flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                </svg>
                                Avoid These Patterns
                            </h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${aiData.antiPatterns.map(pattern => `<li class="flex items-start gap-2"><span class="text-red-500 mt-0.5">â€¢</span><span>${escapeHtml(pattern)}</span></li>`).join('')}
                            </ul>
                        `;
                        adviceContainer.appendChild(antiPatternsDiv);
                    }

                    section.appendChild(adviceContainer);
                }

                return section;
            }

            // Create rule-based section
            function createRuleBasedSection(locators) {
                const section = document.createElement('div');
                section.className = 'locator-section mb-6';
                section.dataset.type = 'rule';

                const header = createSectionHeader('âš™ï¸ Rule-Based Locators', locators.length);
                section.appendChild(header);

                // Group by priority
                const grouped = {
                    high: locators.filter(l => l.priority === 'high'),
                    medium: locators.filter(l => l.priority === 'medium'),
                    low: locators.filter(l => l.priority === 'low')
                };

                Object.entries(grouped).forEach(([priority, items]) => {
                    if (items.length === 0) return;

                    const prioritySection = document.createElement('div');
                    prioritySection.className = 'mb-6';

                    const priorityHeader = document.createElement('h4');
                    priorityHeader.className = `text-md font-semibold mb-4 flex items-center gap-2 ${priority === 'high' ? 'text-green-700' :
                        priority === 'medium' ? 'text-blue-700' : 'text-yellow-700'
                        }`;

                    const priorityIcon =
                        priority === 'high'
                            ? `<svg class="inline-block mr-1" width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="#22c55e"/><path d="M7 10l2 2 4-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
                            : priority === 'medium'
                                ? `<svg class="inline-block mr-1" width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="#3b82f6"/><path d="M7 10h6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`
                                : `<svg class="inline-block mr-1" width="16" height="16" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" fill="#f59e0b"/><path d="M10 7v3l2 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                    priorityHeader.innerHTML = `${priorityIcon} ${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority (${items.length})`;
                    prioritySection.appendChild(priorityHeader);

                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 gap-3';

                    items.forEach(item => {
                        const card = createLocatorCard(item.locator, item.type, item.explanation, item.priority, false);
                        grid.appendChild(card);
                    });

                    prioritySection.appendChild(grid);
                    section.appendChild(prioritySection);
                });

                return section;
            }

            // Main generation function
            generateBtn.addEventListener('click', async () => {
                const htmlContent = htmlInput.value.trim();

                if (!htmlContent) {
                    showToast('Please enter HTML content first', 'warning');
                    return;
                }

                // Clear previous results
                clearOutput();
                showOutput();

                const crazyLoader = document.getElementById('crazy-loader');
                // Show loader
                crazyLoader.classList.remove('hidden');
                outputContent.classList.add('hidden');
                emptyState.classList.add('hidden');

                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                <span class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 0 0-9-9m9 9a9 9 0 0 1-9 9m9-9H3m9 0a9 9 0 1 0 0 18"/>
                    </svg>
                    <span>AI Generating...</span>
                </span>
                `;

                try {
                    // Generate rule-based locators first
                    const ruleBasedLocators = generateRuleBasedLocators(htmlContent);
                    generatedLocators.push(...ruleBasedLocators);

                    let aiSection = null;
                    let aiLocators = [];
                    let ruleSection = null;

                    // Generate AI locators if enabled and API key is available
                    if (document.getElementById('include-ai')?.checked && apiKey) {
                        try {
                            const aiData = await generateAiLocators(htmlContent);

                            if (aiData.recommendations) {
                                aiLocators = aiData.recommendations.map(rec => ({
                                    locator: rec.cssSelector || rec.xpath,
                                    type: rec.cssSelector ? 'CSS' : 'XPath',
                                    priority: rec.priority?.toLowerCase() || 'medium',
                                    explanation: rec.explanation,
                                    source: 'ai'
                                }));
                                generatedLocators.push(...aiLocators);
                            }

                            aiSection = createAiSection(aiData);
                        } catch (aiError) {
                            console.error('AI generation failed:', aiError);
                            showToast(`AI generation failed: ${aiError.message}`, 'error', 5000);

                            // Show setup prompt if API key issue
                            if (aiError.message.includes('API key') || aiError.message.includes('not configured')) {
                                const setupDiv = document.createElement('div');
                                setupDiv.className = 'locator-section p-6 bg-yellow-50 rounded-xl border border-yellow-200 mb-6';
                                setupDiv.innerHTML = `
                                    <div class="text-center">
                                        <img src="image.png" alt="AI" class="mx-auto mb-3 w-12 h-12 rounded-full" />
                                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">ðŸ”‘ API Key Required</h3>
                                        <p class="text-yellow-700 mb-4">Configure your Gemini API key to enable AI-powered suggestions and get smarter locator recommendations.</p>
                                        <button id="setup-api-btn" class="px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                                            Setup API Key
                                        </button>
                                    </div>
                                `;
                                outputContent.appendChild(setupDiv);

                                setupDiv.querySelector('#setup-api-btn').addEventListener('click', openModal);
                            }
                        }
                    }

                    // Always create rule-based section if there are rule-based locators
                    if (ruleBasedLocators.length > 0) {
                        ruleSection = createRuleBasedSection(ruleBasedLocators);
                    }

                    // Show sections in correct order:
                    // - If AI locators present, show AI section first, then rule-based section.
                    // - If only rule-based locators, show just rule-based section.
                    if (aiSection) {
                        outputContent.appendChild(aiSection);
                    }
                    if (ruleSection) {
                        outputContent.appendChild(ruleSection);
                    }

                    if (!aiSection && !ruleSection) {
                        crazyLoader.classList.add('hidden');
                        outputContent.classList.remove('hidden');
                        const noResultsDiv = document.createElement('div');
                        noResultsDiv.className = 'text-center py-16 text-slate-500';
                        noResultsDiv.innerHTML = `
                            <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12h8"></path>
                            </svg>
                            <p class="text-lg font-semibold mb-2">No locators could be generated</p>
                            <p class="text-sm">Try providing HTML with more identifiable elements like IDs, classes, or attributes.</p>
                        `;
                        outputContent.appendChild(noResultsDiv);
                    }

                } catch (error) {
                    console.error('Generation failed:', error);
                    showToast('Failed to generate locators', 'error');

                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'p-6 bg-red-50 rounded-xl border border-red-200 text-center';
                    errorDiv.innerHTML = `
                        <svg class="mx-auto mb-4 text-red-500" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-800 mb-2">Generation Failed</h3>
                        <p class="text-red-700">${escapeHtml(error.message)}</p>
                    `;
                    outputContent.appendChild(errorDiv);
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `
                        <span class="flex items-center justify-center space-x-2">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"></polygon>
                            </svg>
                            <span>Generate Locators</span>
                        </span>
                    `;
                    crazyLoader.classList.add('hidden');
                    outputContent.classList.remove('hidden');
                }
            });

            // Chat functionality
            let isChatting = false;

            chatBubble.addEventListener('click', () => {
                chatModal.classList.remove('invisible', 'opacity-0');
                chatModal.querySelector('.modal-content').classList.remove('scale-95');
                chatInput.focus();
            });

            closeChatModalBtn.addEventListener('click', () => {
                chatModal.classList.add('invisible', 'opacity-0');
                chatModal.querySelector('.modal-content').classList.add('scale-95');
            });

            chatModal.addEventListener('click', (e) => {
                if (e.target === chatModal) {
                    chatModal.classList.add('invisible', 'opacity-0');
                    chatModal.querySelector('.modal-content').classList.add('scale-95');
                }
            });

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!isChatting) {
                        handleChatSend();
                    }
                }
            });

            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            });

            chatSendBtn.addEventListener('click', () => {
                if (!isChatting) {
                    handleChatSend();
                }
            });

            async function handleChatSend() {
                const query = chatInput.value.trim();
                const htmlContent = htmlInput.value.trim();

                if (!query) return;

                if (!apiKey) {
                    showToast('Please set your API key in settings to use AI chat', 'warning');
                    return;
                }

                isChatting = true;
                chatInput.value = '';
                chatInput.style.height = 'auto';
                chatSendBtn.disabled = true;

                // Display user message
                appendMessage(query, 'user');
                const loadingMessage = appendMessage('Thinking...', 'ai', true);

                try {
                    const response = await getChatResponse(query, htmlContent);
                    updateMessage(loadingMessage, response);
                } catch (error) {
                    console.error('Chat error:', error);
                    updateMessage(loadingMessage, `Sorry, I encountered an error: ${error.message}`, true);
                } finally {
                    isChatting = false;
                    chatSendBtn.disabled = false;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            }

            function appendMessage(text, sender, isLoading = false) {
                const messageDiv = document.createElement('div');
                const isUser = sender === 'user';
                messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} fade-in`;

                const contentDiv = document.createElement('div');
                contentDiv.className = `p-3 rounded-xl max-w-[80%] ${isUser
                    ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white'
                    : 'bg-slate-100 text-slate-800'
                    }`;

                if (isLoading) {
                    contentDiv.classList.add('loading-shimmer');
                    contentDiv.textContent = text;
                } else {
                    if (isUser) {
                        contentDiv.textContent = text;
                    } else {
                        contentDiv.innerHTML = `
                            <div class="flex items-start gap-2">
                                <img src="image.png" alt="AI" class="inline-block w-5 h-5 align-middle rounded-full mt-0.5" />
                                <div class="message-content">${showdownConverter.makeHtml(text)}</div>
                            </div>
                        `;
                    }
                }

                messageDiv.appendChild(contentDiv);
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                return contentDiv;
            }

            function updateMessage(element, newText, isError = false) {
                element.classList.remove('loading-shimmer');
                if (isError) {
                    element.classList.remove('bg-slate-100', 'text-slate-800');
                    element.classList.add('bg-red-100', 'text-red-800');
                }

                element.innerHTML = `
                    <div class="flex items-start gap-2">
                        <img src="image.png" alt="AI" class="inline-block w-5 h-5 align-middle rounded-full mt-1 flex-shrink-0" />
                        <div class="message-content">${showdownConverter.makeHtml(newText)}</div>
                    </div>
                `;
            }

            async function getChatResponse(query, htmlContent) {
                const prompt = `You are an AI assistant for a web testing locator generator tool. The user has provided HTML and asks a question.
                                HTML Context:
                                \`\`\`html
                                ${htmlContent || 'No HTML provided yet.'}
                                \`\`\`

                                User Question: ${query}
                                Provide a helpful, concise response. If the question is about locators, suggest specific selectors. Use markdown formatting for code and emphasis. Keep responses focused and practical.`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const content = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!content) {
                    throw new Error('Empty response from AI');
                }

                return content;
            }

            // Initialize app
            document.addEventListener('DOMContentLoaded', () => {
                loadSettings();

                // Auto-resize textarea
                htmlInput.addEventListener('input', () => {
                    htmlInput.style.height = 'auto';
                    htmlInput.style.height = Math.min(htmlInput.scrollHeight, 400) + 'px';
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (!generateBtn.disabled) {
                                generateBtn.click();
                            }
                        } else if (e.key === ',' && e.shiftKey) {
                            e.preventDefault();
                            openModal();
                        }
                    }
                });

                // Add sample HTML for demo
                if (!htmlInput.value.trim()) {
                    const sampleHtml = `
                    <div class="login-form">
                    <h2 id="login-title">Sign In</h2>
                    <form data-testid="login-form">
                        <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter password" required>
                        </div>
                        <div class="form-actions">
                        <button type="submit" class="btn btn-primary" data-testid="login-button">
                            Log In
                        </button>
                        <a href="/forgot-password" class="forgot-link">Forgot Password?</a>
                        </div>
                    </form>
                    </div>
                        `.trim();
                    htmlInput.value = formatHtml(sampleHtml);
                }
                showToast('E2E Locator Generator ready! Try generating locators from the sample HTML.', 'success', 4000);
            });
        </script>
    </div>
</body>

</html>